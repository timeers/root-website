{% extends 'the_keep/base.html' %}
{% load text_filters roman_numerals i18n static %}

{% block meta %}    <!-- Open Graph tags -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:image" content="{% static 'images/law-icon.png' %}">
<meta property="og:site_name" content="{{ site_title }}">
{% if law_meta_title %}
  <meta property="og:title" content="{{ law_meta_title|format_law_text_only }}">
  <meta property="og:description" content="{{ law_meta_description|format_law_text_only }}">
  <meta name="description" content="{{ law_meta_description|format_law_text_only }}">
{% else %}
  {% trans "The Law of Root" as law_of_root_title %}
  {% if post %}
      <meta property="og:title" content="{{ law_of_root_title }} - {{ post.title }}">
      {% blocktrans with post_title=post.title %}
          <meta property="og:description" content="The strictly defined, formal rules of {{ post_title }}">
          <meta name="description" content="The strictly defined, formal rules of {{ post_title }}">
      {% endblocktrans %}
  {% else %}
      {% trans 'The strictly defined, formal rules of Root in a concise reference style.' as law_description %}
      <meta property="og:title" content="{{ law_of_root_title }}">
      <meta property="og:description" content="{{ law_description }}">
      <meta name="description" content="{{ law_description }}">
  {% endif %}
{% endif %}
{% endblock meta %}


{% block content %}

<div class='mb-2 d-flex justify-content-between'>

    <a href="{% url 'law-of-root' language_code=language_code %}" class="content-box d-flex align-items-center clickable-segment text-center">
        <div class='d-flex align-items-center mr-1'>
        <i class="bi bi-chevron-left"></i> 
        </div>
        <div class='d-flex mx-auto'>
          Table of Contents
        </div>

    </a>

    {% if group.post %}
    <a href="{{ group.post.get_absolute_url }}?lang={{language_code}}" class="content-box d-flex align-items-center clickable-segment text-center">
  
        <div class='d-flex mx-auto'>
          View {{ prime_law.title }} 
        </div>


    </a>
  {% else %}
    <div class='d-flex align-items-center mr-1'></div>
  {% endif %}


</div>


<article class="content-section d-flex justify-content-between align-items-center{% if not group.public %} light-yellow{% endif %}">
  <div class='mx-auto text-center'>
  {% if group.public %}
    <h1 class='root-title'>{% trans 'Law of Root' %}</h1>
  {% else %}
    <h1 class='root-title'>{% trans 'Law of Root (Draft)' %}</h1>
    <small>*Set to "Public" in the settings once finalized</small>
  {% endif %}
  
  </div>
  <div>
 
          {% if available_languages or edit_authorized %}
                
                <div class="dropdown d-inline">
                  <button class="btn btn-sm dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <small><i class="bi bi-translate"></i> {{ selected_language.name }}</small>
                  </button>
                  
                  <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                    
               
                        {% if available_languages %}
                            {% for lang in available_languages %}
                              <li>
                                <a class="dropdown-item" href="{% url 'law-view' slug=group.slug language_code=lang.code %}"><small>{{ lang.name }}</small></a>
                              </li>
                            {% endfor %}
                        {% endif %}
                        
                        {% if edit_authorized %}
                        
                            {% if available_languages %}
                              <li><hr class="dropdown-divider"></li>
                              {% endif %}
                          <li>
                            <a class="dropdown-item" href="{% url 'copy-law-group' slug=group.slug language_code=language_code %}"><small>Add Language</small></a>
                          </li>
                        {% endif %}

                  </ul>
                </div>
            
          {% else %}
                  <small>
                      {{ selected_language }}
                  </small>
          {% endif %}
  
  </div>

</article>

{% if group %}
<article class="content-section markdown-section">
  <div id="law-{{ prime_law.id }}">
    <div class="d-flex justify-content-between align-items-center">
      <div id="group-{{ group.id }}" class='d-flex'>
        {% if group.post %}
          <a href='{{ group.post.get_absolute_url }}{% if language_code %}?lang={{ language_code }}{% endif %}'>
        {% endif %}
        <h2 class='root-title'>{{ group.abbreviation }}. {{ prime_law.title }}
          {% if group.post %}
            {% if group.post.component == 'Faction' or group.post.component == 'Clockwork' %}
                <img class="lg-faction-icon" src="{{ group.post.small_icon.url }}">
            {% endif %}
          {% endif %}

        </h2>
        {% if group.post %}
          </a>
        {% endif %}
      </div>
        <div class="d-flex flex-wrap justify-content-end">

        {% if edit_authorized %}
            
          {% if edit_mode %}
            <a class="btn btn-primary btn-sm mt-1 mb-1 ml-1" href="{% url 'export-laws-yaml' group.slug language_code %}">
              <i class="bi bi-download"></i>
            </a>
          
            <a class="btn btn-danger btn-sm mt-1 mb-1 ml-1" href="{% url 'delete-law-group' slug=group.slug language_code=language_code %}">
                <i class="bi bi-trash"></i>
            </a>
            <a class="btn btn-warning btn-sm mt-1 mb-1 ml-1" href="{% url 'update-law-group' slug=group.slug language_code=language_code %}">
              <i class="bi bi-gear-wide-connected"></i>
            </a>
              <a class="btn btn-success btn-sm mt-1 mb-1 ml-1" href="{% url 'law-view' slug=group.slug language_code=language_code %}">
                  {% trans 'Done' %} <i class="bi bi-check"></i>
              </a>
          {% else %}
              <a class="btn btn-warning btn-sm mt-1 mb-1 ml-1" href="{% url 'edit-law-view' slug=group.slug language_code=language_code %}">
                  {% trans 'Edit Law' %} <i class="bi bi-pencil-square"></i>
              </a>
          {% endif %}
            
        {% endif %}
      </div>
    </div>
    {% if prime_law.description %}
      {{ prime_law.description|format_law_text:language_code }}
      {% comment %} {% format_law_text prime_law.description language_code %} {% endcomment %}
    {% endif %}
    {% if prime_law.reference_laws %}
      {% for reference in prime_law.reference_laws.all %}
        {% include 'the_keep/partials/law_reference.html' %}
      {% endfor %}
    {% endif %}
    {% if edit_mode and prime_law %}
      {% with prime_law as selected_law %}
          {% include 'the_keep/partials/law_buttons.html' %}
      {% endwith %}
    {% endif %}
  </div>

    <div class=''>
 
        {% for law in top_level_laws %}
   
          <div id="law-{{ law.id }}">
            <div class="d-flex justify-content-between align-items-center">
              {% comment %} <h4>{{ law.local_code }} <span class="smart-smallcaps">{{ law.title }}</span></h4> {% endcomment %}
              <h4>{{ law.local_code }} <span class="smart-smallcaps">{{ law.title|emphasize_caps }}</span></h4>
              {% with law as selected_law %}
                {% include 'the_keep/partials/law_copy_button.html' %}
              {% endwith %}
            </div>
            {{ law.description|format_law_text:language_code }}
            {% comment %} {% format_law_text law.description language_code %} {% endcomment %}
            {% if law.reference_laws %}
              {% for reference in law.reference_laws.all %}
                {% include 'the_keep/partials/law_reference.html' %}
              {% endfor %}
            {% endif %}
            {% if edit_mode %}
              {% with law as selected_law %}
                  {% include 'the_keep/partials/law_buttons.html' %}
              {% endwith %}
            {% endif %}

            {% for child in law.children.all %}

              <div class='law-entry' id="law-{{ child.id }}">
                <div>
                <span class='law-code'>{{ child.local_code }}</span> 
                </div>
                <div class="law-content">
                  <div class="d-flex justify-content-between align-items-center">
                    <strong>{{ child.title|ensure_punctuation|format_law_text_no_link }}</strong>
                      {% with child as selected_law %}
                        {% include 'the_keep/partials/law_copy_button.html' %}
                      {% endwith %}
                  </div>

                  {{ child.description|format_law_text:language_code }}
                  {% comment %} {% format_law_text child.description language_code %} {% endcomment %}
                  {% if child.reference_laws %}
                    {% for reference in child.reference_laws.all %}
                      {% include 'the_keep/partials/law_reference.html' %}
                    {% endfor %}
                  {% endif %}
                  {% if edit_mode %}
                    {% with child as selected_law %}
                        {% include 'the_keep/partials/law_buttons.html' %}
                    {% endwith %}
                  {% endif %}

                    {% for grandchild in child.children.all %}
                      <div class='law-entry-sm' id="law-{{ grandchild.id }}">
                        <span class='law-code'>{{ grandchild.local_code }}</span> 
                        <div class="law-content">
                          <div class="d-flex justify-content-between align-items-center">
                            <strong>{{ grandchild.title|ensure_punctuation|format_law_text_no_link }}</strong>
                              {% with grandchild as selected_law %}
                                {% include 'the_keep/partials/law_copy_button.html' %}
                              {% endwith %}
                          </div>

                          {{ grandchild.description|format_law_text:language_code }}
                          {% comment %} {% format_law_text grandchild.description language_code %} {% endcomment %}
                          {% if grandchild.reference_laws %}
                            {% for reference in grandchild.reference_laws.all %}
                              {% include 'the_keep/partials/law_reference.html' %}
                            {% endfor %}
                          {% endif %}

                          {% if edit_mode %}
                            {% with grandchild as selected_law %}
                                {% include 'the_keep/partials/law_buttons.html' %}
                            {% endwith %}
                          {% endif %}

                          {% for great_grandchild in grandchild.children.all %}
                            <div class='law-entry-sm' id="law-{{ great_grandchild.id }}">
                              <span class='law-code'>{{ great_grandchild.local_code }}</span> 
                              <div class="law-content">
                                <div class="d-flex justify-content-between align-items-center">
                                  <strong>{{ great_grandchild.title|ensure_punctuation|format_law_text_no_link }}</strong>
                                  {% with great_grandchild as selected_law %}
                                    {% include 'the_keep/partials/law_copy_button.html' %}
                                  {% endwith %}  
                                </div>
                                {{ great_grandchild.description|format_law_text:language_code }}
                                {% comment %} {% format_law_text great_grandchild.description language_code %} {% endcomment %}
                                {% if great_grandchild.reference_laws %}
                                  {% for reference in great_grandchild.reference_laws.all %}
                                    {% include 'the_keep/partials/law_reference.html' %}
                                  {% endfor %}
                                {% endif %}
                                {% if edit_mode %}
                                  {% with great_grandchild as selected_law %}
                                      {% include 'the_keep/partials/law_buttons.html' %}
                                  {% endwith %}
                                {% endif %}
                              </div>


                            </div>

                            {% if forloop.last and edit_mode and grandchild.allow_sub_laws %}
                                    <div class='mt-2 ml-5'>
                                        <button class="btn btn-sm btn-success add-law-button"
                                                data-code="{{ grandchild.law_code }}{{ forloop.counter|add:"1"|alpha }}"
                                                data-group="{{ group.id }}"
                                                data-parent="{{ grandchild.id }}"
                                                data-prev=""
                                                data-next="">
                                            Add {{ grandchild.law_code }}{{ forloop.counter|add:"1"|alpha }}
                                        </button>
                                    </div>
                              {% endif %}
                          {% empty %}

                            {% if edit_mode and grandchild.allow_sub_laws %}
                                  <div class='mt-2 ml-5'>
                                      <button class="btn btn-sm btn-success add-law-button"
                                              data-code="{{ grandchild.law_code }}a"
                                              data-group="{{ group.id }}"
                                              data-parent="{{ grandchild.id }}"
                                              data-prev=""
                                              data-next="">
                                          
                                          Add {{ grandchild.law_code }}a
                                      </button>
                                  </div>
                            {% endif %}

                          {% endfor %}
                          </div>  


                      </div>

                      
                          {% if forloop.last and edit_mode and child.allow_sub_laws %}
                              <div class='mt-2 ml-5'>
                                  <button class="btn btn-sm btn-success add-law-button"
                                          data-code="{{ child.law_code }}.{{ forloop.counter|add:"1"|roman }}"
                                          data-group="{{ group.id }}"
                                          data-parent="{{ child.id }}"
                                          data-prev=""
                                          data-next="">
                                      Add {{ child.law_code }}.{{ forloop.counter|add:"1"|roman }}
                                  </button>
                              </div>
                          
                          {% endif %}
                    {% empty %}

                      {% if edit_mode and child.allow_sub_laws %}
                          <div class='mt-2 ml-5'>
                              <button class="btn btn-sm btn-success add-law-button"
                                      data-code="{{ child.law_code }}.I"
                                      data-group="{{ group.id }}"
                                      data-parent="{{ child.id }}"
                                      data-prev=""
                                      data-next="">
                                  Add {{ child.law_code }}.I
                              </button>
                          </div>
                      
                      {% endif %}

                    {% endfor %}
                </div>

              </div>
                  {% if forloop.last and edit_mode and law.allow_sub_laws %}
                        <div class='mt-2 ml-5'>
                            <button class="btn btn-sm btn-success add-law-button"
                                data-code="{{ law.law_code }}.{{ forloop.counter|add:"1" }}"
                                data-group="{{ group.id }}"
                                data-parent="{{ law.id }}"
                                data-prev=""
                                data-next="">
                                Add {{ law.law_code }}.{{ forloop.counter|add:"1" }}
                            
                            </button>
                        </div>
                      {% endif %}
            {% empty %}
                {% if edit_mode and law.allow_sub_laws %}
                    <div class='mt-2 ml-5'>
                        <button class="btn btn-sm btn-success add-law-button"
                            data-code="{{ law.law_code }}.1"
                            data-group="{{ group.id }}"
                            data-parent="{{ law.id }}"
                            data-prev=""
                            data-next="">
                            Add {{ law.law_code }}.1
                        
                        </button>
                    </div>
                  {% endif %}
            {% endfor %}
          </div>


          {% if forloop.last %}

              {% if edit_mode %}
                <div class='mt-2'>
                    <button class="btn btn-sm btn-success add-law-button"
                        data-code="{{ group.abbreviation }}.{{ forloop.counter|add:"1" }}"
                        data-group="{{ group.id }}"
                        data-prev="{{ law.id }}"
                        data-next="">
                        Add {{ group.abbreviation }}.{{ forloop.counter|add:"1" }}
                    </button>
                </div>
              {% endif %}

          {% endif %}
        {% empty %}

          {% if edit_mode %}
            <div class='mt-2'>
                <button class="btn btn-sm btn-success add-law-button"
                    data-code="{{ group.abbreviation }}.1"
                    data-group="{{ group.id }}"
                    data-prev=""
                    data-next="">
                    Add {{ group.abbreviation }}.1
                </button>
            </div>
          {% endif %}
                
        {% endfor %}
      
    </div>
 
</article>
{% else %}
<article class="media content-section d-flex justify-content-between align-items-center">
  
  {% if post %}
    {% if available_languages %}
        {% blocktrans with post.title as post_title %}
          No {{selected_language }} Laws Recorded for {{ post_title }}
        {% endblocktrans %}
    {% else %}
        {% blocktrans with post.title as post_title %}
          No Laws Recorded for {{ post_title }}
        {% endblocktrans %}
    {% endif %}
    {% if user.profile.admin or user.profile == post.designer and user.profile.editor %}
      <div class="d-flex flex-wrap justify-content-end">

          <a class="btn btn-success btn-sm mt-1 mb-1 ml-1" href="{% url 'post-law-group-create' slug=post.slug %}">
              {% trans 'Add Laws' %} <i class="bi bi-plus"></i>
          </a>

      </div>
    {% else %}
      {% if available_languages %}
          {% trans 'No Laws Recorded' %}
      {% else %}
          {% blocktrans %}
            No {{selected_language }} Laws Recorded
          {% endblocktrans %}
      {% endif %}
    {% endif %}
  {% endif %}


</article>
{% endif %}



{% if edit_mode %}




  {% comment %} Modals for CRUD {% endcomment %}

  <div id="add-law-modal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <button type="button" class="modal-close-button" onclick="hideModal(this.closest('.modal-overlay'))">×</button>

    <form id="add-law-form">
      {% csrf_token %}
      <input type="hidden" name="group_id" id="modal-group-id">
      <input type="hidden" name="parent_id" id="modal-parent-id">
      <input type="hidden" name="prev_id" id="modal-prev-id">
      <input type="hidden" name="next_id" id="modal-next-id">
      <input type="hidden" name="language_id" id="modal-language-id">
      <div class='root-title h3' id='modal-law-code'></div>
      <label class='hidden'>Title</label>
      <input type="text" name="title" required placeholder="Title..."><br>

      <label class='hidden'>Description</label>
      <textarea name="description" placeholder="Description..." rows="6"></textarea><br>
      <div class='mb-3'>
        <small>Use {% open_braces %}x{% close_braces %} for animal or item icons, _x_ for italics, and **x** for small caps.</small>
      </div>

      <label for="id_reference_laws" class='hidden'>Reference Laws:</label>
      <div class='mb-4'>
        <select name="reference_laws" id="id_reference_laws" multiple class="multi-select">
          {% for law in all_laws %}
            <option value="{{ law.id }}">{{ law.law_code }} {% if law.group.post %}{{ law.group.post }} {% endif %}- {{ law.title }}</option>
          {% endfor %}
        </select>
      </div>

      <button class='btn btn-sm btn-primary' type="submit">Add Law</button>
    </form>
  </div>
  </div>

  <div id="edit-law-modal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <button type="button" class="modal-close-button" onclick="hideModal(this.closest('.modal-overlay'))">×</button>
        <form id="edit-law-form">
        {% csrf_token %}
        <input type="hidden" name="law_id" id="edit-law-id">
        <div class='root-title h3' id='edit-law-law-code'></div>
        <label for="edit-law-title" class="hidden">Title:</label>
        <input type="text" name="title" id="edit-law-title" required placeholder='Title...'>
        
        <label for="edit-law-description" class='hidden'>Description:</label>
        <textarea name="description" id="edit-law-description" placeholder='Description...' rows="6"></textarea>
        <div class='mb-3'>
          <small>Use {% open_braces %}x{% close_braces %} for animal or item icons, _x_ for italics, and **x** for small caps.</small>
        </div>


        <label for="id_edit_reference_laws" class='hidden'>Reference Laws:</label>
        <div class='mb-4'>
          <select name="reference_laws" id="id_edit_reference_laws" multiple class="multi-select">
              {% for law in all_laws %}
                  <option value="{{ law.id }}">{{ law.law_code }} {% if law.group.post %}{{ law.group.post }} {% endif %}- {{ law.title }}</option>
              {% endfor %}
          </select>
        </div>

        <button class='btn btn-sm btn-primary' type="submit">Save</button>
        <button class='btn btn-sm btn-secondary' type="button" onclick="document.getElementById('edit-law-modal').style.display='none'">Cancel</button>
        </form>
    </div>
  </div>

  <div id="edit-description-modal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <button type="button" class="modal-close-button" onclick="hideModal(this.closest('.modal-overlay'))">×</button>
        <form id="edit-description-form">
        {% csrf_token %}
        <input type="hidden" name="law_id" id="edit-description-id">
        
        <div class='root-title h3' id='edit-description-law-code'></div>
        <div id='readonly-law-title'></div>
        
        <label for="edit-description-description" class='hidden'>Description:</label>
        <textarea name="description" id="edit-description-description" placeholder='Description...' rows="6"></textarea>
        <div class='mb-3'>
        <small>Use {% open_braces %}x{% close_braces %} for animal or item icons, _x_ for italics, and **x** for small caps.</small>
        </div>

        <label for="id_edit_description_reference_laws" class='hidden'>Reference Laws:</label>
        <div class='mb-4'>
          <select name="reference_laws" id="id_edit_description_reference_laws" multiple class="multi-select">
              {% for law in all_laws %}
                  <option value="{{ law.id }}">{{ law.law_code }} {% if law.group.post %}{{ law.group.post }} {% endif %}- {{ law.title }}</option>
              {% endfor %}
          </select>
        </div>
        <button class='btn btn-sm btn-primary' type="submit">Save</button>
        <button class='btn btn-sm btn-secondary' type="button" onclick="document.getElementById('edit-description-modal').style.display='none'">Cancel</button>
        </form>
    </div>
  </div>

  <div id="delete-law-modal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <button type="button" class="modal-close-button" onclick="hideModal(this.closest('.modal-overlay'))">×</button>
        <form id="delete-law-form">
        {% csrf_token %}
        <input type="hidden" name="law_id" id="delete-law-id">
        <p>Are you sure you want to delete <strong id="delete-law-title"></strong>?</p>
        <button class='btn btn-sm btn-danger' type="submit">Yes, delete</button>
        <button class='btn btn-sm btn-secondary' type="button" onclick="document.getElementById('delete-law-modal').style.display='none'">Cancel</button>
        </form>
    </div>
  </div>
{% endif %}



{% if group.public %}
  <div class='mb-3 d-flex justify-content-between'>

    {% if previous_group %}
      <a href="{% url 'law-view' slug=previous_group.slug language_code=language_code %}" class="content-box d-flex align-items-center clickable-segment text-center">
          <div class='d-flex align-items-center mr-1'>
          <i class="bi bi-chevron-left"></i> 
          </div>
          <div class='d-flex mx-auto'>
            {{ previous_name }}
          </div>

      </a>
    {% else %}
      <div class='d-flex align-items-center mr-1'></div>
    {% endif %}

    <div class='d-flex align-items-center mr-1'></div>


    {% if next_group %}
      <a href="{% url 'law-view' slug=next_group.slug language_code=language_code %}" class="content-box d-flex align-items-center clickable-segment text-center">
    
          <div class='d-flex mx-auto'>
            {{ next_name }} 
          </div>
          <div class='d-flex align-items-center ml-1'>
            <i class="bi bi-chevron-right"></i>
          </div>

      </a>
    {% else %}
      <div class='d-flex align-items-center mr-1'></div>
    {% endif %}
    
  </div>
{% endif %}


{% if date_updated %}

  <div class='mb-3 d-flex justify-content-center subtle-link'>
      <a href={{law_link}}>
        <small>
          Law of Root updated on {{date_updated|date:"F j, Y"}}
        </small>
      </a>
  </div>

{% endif %}


    <!-- Option to send Feedback -->
     <div class='mb-2 d-flex justify-content-between'>
        <a href="{% url 'law-feedback' slug=group.slug language_code=language_code %}" class='subtle-link'>
            <small>
                {% trans 'Is something missing or incorrect?' %}
            </small>
        </a>
     </div>

{% endblock content %}

{% block scripts %}
{% include 'the_keep/partials/law_scripts.html' %}
{% endblock scripts %}
