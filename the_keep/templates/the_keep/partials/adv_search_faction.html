{% load i18n %}
<div class="manifest-box mb-1 text-center">
  <!-- Title at the top -->
  <label class="root-title manifest-title h3 mb-3">{% trans 'Faction Type' %}</label>

  <!-- Row containing Faction Type and Reach -->
  <div class="d-flex flex-wrap justify-content-around align-items-center w-100 px-3">

    <!-- Faction Type -->
    <div class="mx-4 text-center">
      <div class="button-select-group mb-3" data-target="faction_type">
        <div class="button-option select-option root-title" data-value="">{% trans 'Any' %}</div>
        <div class="button-option select-option root-title" data-value="M">{% trans 'Militant' %}</div>
        <div class="button-option select-option root-title" data-value="I">{% trans 'Insurgent' %}</div>
      </div>
      <input type="hidden" name="faction_type" id="faction_type" value="{{ faction_type }}">
    </div>

    <!-- Reach -->
    <div class="mx-4 text-center">
      {% include "the_keep/partials/adv_quantity_filter.html" with prefix="reach" label="Reach" op=reach_op qty=reach_qty %}
    </div>
  </div>
</div>



<div>
    <label class='root-title h3'>Faction Attributes</label>

    <div class="row">
        <div class="col-12 col-md-6">

            <div class="bar-click-zone" data-field-name="complexity">
                <div class="bar-container">
                    <div class="bar-label">Complexity</div>
                    <div class="bar-background">
                        <div class="bar-text"></div>
                    </div>
                </div>
              </div>
              <input type="hidden" name="complexity" id="complexity" value="">    

              <div class="bar-click-zone" data-field-name="aggression">
                <div class="bar-container">
                    <div class="bar-label">Aggression</div>
                    <div class="bar-background">
                        <div class="bar-text"></div>
                    </div>
                </div>
              </div>
              <input type="hidden" name="aggression" id="aggression" value="">
              
        </div>
        <div class="col-12 col-md-6">

            <div class="bar-click-zone" data-field-name="card_wealth">
                <div class="bar-container">
                    <div class="bar-label">Card Wealth</div>
                    <div class="bar-background">
                        <div class="bar-text"></div>
                    </div>
                </div>
              </div>
              <input type="hidden" name="card_wealth" id="card_wealth" value="">

              <div class="bar-click-zone" data-field-name="crafting_ability">
                <div class="bar-container">
                    <div class="bar-label">Crafting Ability</div>
                    <div class="bar-background">
                        <div class="bar-text"></div>
                    </div>
                </div>
              </div>
              <input type="hidden" name="crafting_ability" id="crafting_ability" value="">
              
        </div>
    </div>


</div>



  {% block scripts %}
  <script>
    window.initialBarValues = {
        aggression: "{{ aggression|default:'' }}",
        complexity: "{{ complexity|default:'' }}",
        card_wealth: "{{ card_wealth|default:'' }}",
        crafting_ability: "{{ crafting_ability|default:'' }}"
      };


    const states = [
    { class: "bar-background-any", label: "Any", blackText: true, value: "" },
    { class: "bar-background-high", label: "High", blackText: false, value: "H" },
    { class: "bar-background-moderate", label: "Moderate", blackText: false, value: "M" },
    { class: "bar-background-low", label: "Low", blackText: false, value: "L" },
    { class: "bar-background-none", label: "None", blackText: true, value: "N" }
  ];
  
  function getStateByValue(value) {
    return states.find(s => s.value === value) || states[0]; // default to "Any"
  }
  
  function updateBarState(zone, state) {
    const bar = zone.querySelector(".bar-background");
    const textElement = bar.querySelector(".bar-text");
    const currentClass = Array.from(bar.classList).find(cls =>
      cls.startsWith("bar-background-")
    );
  
    if (currentClass) bar.classList.remove(currentClass);
    bar.classList.add(state.class);
  
    if (textElement) {
        textElement.textContent = state.label;
      
        // Dynamically determine if current --bar-color is light
        const barColor = getComputedStyle(bar).getPropertyValue('--bar-color').trim().toLowerCase();
        const isLightColor = lightColors.includes(barColor);
      
        // Add black text if either the state requires it OR the color is light
        if (state.blackText || isLightColor) {
          textElement.classList.add('bar-black-text');
        } else {
          textElement.classList.remove('bar-black-text');
        }
      }
      

      
    // Update hidden input
    const fieldName = zone.dataset.fieldName;
    const hiddenInput = document.getElementById(fieldName);
    if (hiddenInput) {
      hiddenInput.value = state.value;
    }
  }
  
  document.addEventListener("DOMContentLoaded", () => {
    const initialValues = window.initialBarValues || {};
  
    document.querySelectorAll(".bar-click-zone").forEach(zone => {
      const fieldName = zone.dataset.fieldName;
      const initialValue = initialValues[fieldName] || "";
      const initialState = getStateByValue(initialValue);
  
      // Set initial state
      updateBarState(zone, initialState);
  
      // Enable click to cycle
      zone.addEventListener("click", () => {
        const bar = zone.querySelector(".bar-background");
        const currentClass = Array.from(bar.classList).find(cls =>
          cls.startsWith("bar-background-")
        );
        const currentIndex = states.findIndex(s => s.class === currentClass);
        const nextIndex = (currentIndex + 1) % states.length;
        updateBarState(zone, states[nextIndex]);
      });
    });
  });
    
    </script>
    

  {% endblock scripts %}