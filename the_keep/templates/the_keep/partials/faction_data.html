<article class="media content-section">
    <div class="media-body">

    <h2>Faction Data</h2>

    {% if object.description %}
        <h3>Description</h3>
        <p class="article-content">{{ object.description }}</p>
    {% endif %}

    <table>
        <thead>
            <tr>
                <th>Complexity</th>
                <th>Card Wealth</th>
                <th>Aggression</th>
                <th>Crafting Ability</th>
            </tr>
        </thead>
        <tbody class="effort-rows">
            <tr>
                <td>
                    {{ object.get_complexity_display }}
                </td>
                <td>
                    {{ object.get_card_wealth_display }}
                </td>
                <td>
                    {{ object.get_aggression_display }}
                </td>
                <td>
                    {{ object.get_crafting_ability_display }}
                </td>
            </tr>
        </tbody>
    </table>

        <div class="article-content">
            {% if object.card_image %}
                <img class="adset-img" src="{{ object.card_image.url }}">
            {% else %}
                {% if object.reach > 0 %}
                {{ object.get_type_display }} ({{ object.reach }} Reach)
                {% endif %}
            {% endif %}
        </div> 
        {% if object.board_image %}
            <img class="rounded-corner-img responsive-img" src="{{ object.board_image.url }}">
        {% endif %}
        
        {% include 'the_keep/partials/pieces.html' %}
        
        {% if object.board_2_image %}
            <img class="rounded-corner-img responsive-img" src="{{ object.board_2_image.url }}">
        {% endif %}
    </div>
</article>

{% if user.profile.player %}
{% if top_players or most_players %}
<article class="media content-section">
    <div class="media-body">

    <h2>Leaderboard{% if top_players and most_players %}s{% endif %}</h2>

    {% if top_players and most_players %}
    <ul class="nav nav-tabs" id="leaderboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="winrate-leaderboard-tab" data-bs-toggle="tab" href="#winrate-leaderboard" role="tab" aria-controls="winrate-leaderboard" aria-selected="true">By Winrate</a>
        </li>    
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="game-leaderboard-tab" data-bs-toggle="tab" href="#game-leaderboard" role="tab" aria-controls="game-leaderboard" aria-selected="false">By Games Won</a>
        </li>        
        
    </ul>
    {% endif %}



    {% if top_players %}
        {% if top_players and most_players %}
        <div class="tab-content" id="tab-contents">
            <div class="tab-pane active" id="winrate-leaderboard" role="tabpanel" aria-labelledby="winrate-leaderboard-tab">
        {% else %}
            <h4>By Winrate</h4>
        {% endif %}
        {% with top_players as leaderboard_players %}
            {% include 'the_gatehouse/partials/leaderboard.html' %}
        {% endwith %}
        {% if top_players and most_players %}
            </div>
        {% endif %}
    {% endif %}
    {% if top_players and most_players %}
        <div class="tab-pane" id="game-leaderboard" role="tabpanel" aria-labelledby="game-leaderboard-tab">
    {% else %}
    <h4>By Games Won</h4>
    {% endif %}
    {% with most_players as leaderboard_players %}
        {% include 'the_gatehouse/partials/leaderboard.html' %}
    {% endwith %}
    {% if top_players and most_players %}
        </div>
        </div>
    {% endif %}
    </div>
    
</article>
{% endif %}
{% endif %}


<article class="media content-section" id="factionCharts">
    <div class="media-body">
        <div class="chart-container">
            <div class="chart" id="lineChartContainer">
                <h2>Point Breakdown</h2>
                <div id='pieDescription'>
                    Average points by category and per turn<br>
                    Faction points are scored with faction abilities, crafting points are from crafting items, battle points are from removing cardboard in battle, other points are anything else.
                </div>
                Based on:
                <div id="titleGames">
                    x Faction Games
                </div>
                <div id="typeGames">
                    x Type Games
                </div>
                <div id="totalGames">
                    x Total Games
                </div>
                
            </div>
            <div class="chart" id="pieChartContainer">
                <canvas id="pieChart"></canvas>  <!-- Pie Chart -->
            </div>

        </div>
        <div class="chart-container">
            <div class="chart" id="lineChartContainer">
                <canvas id="scorecardChart" width="400" height="400"></canvas>  <!-- Line Chart -->
            </div>
        </div>
    </div>
</article>




{% block scripts %}

 <script>
  // Get the scorecard ID and faction slug dynamically from the template
  const factionSlug = "{{ object.slug }}";  // Replace with actual faction slug
  const factionType = "{{ object.type }}";
  const averageEndpoint = `/api/scorecard/average/`;  // API endpoint for the scorecard data
  const factionEndpoint = `/api/scorecard/faction/${factionSlug}/`;  // API endpoint for the faction average data
  const typeEndpoint = `/api/scorecard/average/?type=${factionType}`;

  // Fetch both data endpoints in parallel using Promise.all
  Promise.all([
      fetch(averageEndpoint).then(res => res.json()),  // Fetch scorecard data
      fetch(factionEndpoint).then(res => res.json()),     // Fetch faction average data
      fetch(typeEndpoint).then(res => res.json())
  ])
    .then(([averageData, factionData, typeData]) => {

        // Check if the response contains the "No scorecards found" message
        if (factionData.message && factionData.message === "No scorecards found.") {
        const factionChartsElement = document.getElementById('factionCharts');
        if (factionChartsElement) {
            factionChartsElement.remove();  // This will remove the entire element
        }
        return;  // Exit the function if no scorecards are found
        }
        // console.log("Still in Function")
        // Line Chart Data Processing for the Scorecard Data
        let color = factionData.color ? factionData.color : '#000000';  // Default color if not provided

        // Get the turn numbers and game points from scorecard data
        const averageTurns = averageData.averages.map(avg => avg.turn_number);
        const gamePoints = averageData.averages.map(avg => avg.average_game_points);

        // Line Chart Data Processing for the Faction Average Data
        const factionTurns = factionData.averages.map(fac => fac.turn_number);
        const factionGamePoints = factionData.averages.map(fac => fac.average_game_points);

        // Get the turn numbers and game points from scorecard data
        const typeTurns = typeData.averages.map(avg => avg.turn_number);
        const typeGamePoints = typeData.averages.map(avg => avg.average_game_points);

        // Combine turn numbers from both datasets and get the full range of turns
        const allTurnNumbers = [...new Set([
            ...averageTurns,  // Turn numbers from scorecard
            ...factionTurns,     // Turn numbers from faction average
            ...typeTurns,
        ])];

        // Determine the min and max turn numbers
        const minTurnNumber = Math.min(...allTurnNumbers);  // Minimum turn number (usually 1)
        const maxTurnNumber = Math.max(...allTurnNumbers);  // Maximum turn number

        // Ensure that both datasets (scorecard and faction average) have data for all turns
        const completeAverageGamePoints = allTurnNumbers.map(turnNumber => {
            const avg = averageData.averages.find(avg => avg.turn_number === turnNumber);
            return avg ? avg.average_game_points : null;  // Use 0 if the turn is missing (avoid null)
        });

        const completeFactionGamePoints = allTurnNumbers.map(turnNumber => {
            const fac = factionData.averages.find(fac => fac.turn_number === turnNumber);
            return fac ? fac.average_game_points : null;  // Use 0 if the turn is missing (avoid null)
        });

        const completeTypeGamePoints = allTurnNumbers.map(turnNumber => {
            const avg = typeData.averages.find(avg => avg.turn_number === turnNumber);
            return avg ? avg.average_game_points : null;  // Use 0 if the turn is missing (avoid null)
        });

        let typeColor, typeName;  // Declare variables outside the if-else block

        if (factionType === "M") {
            typeColor = '#FE0000';
            typeName = 'Militant';
        } else {
            typeColor = '#9D9A9A';
            typeName = 'Insurgent';
        }
        // Replace the text content in the divs
        document.getElementById('titleGames').innerHTML = `${factionData.count} ${factionData.faction_name} Games`;
        document.getElementById('typeGames').innerHTML = `${typeData.count} ${typeName} Games`;
        document.getElementById('totalGames').innerHTML = `${averageData.count} Total Games`;

        // Initialize the Combined Line Chart (for both Scorecard and Faction Average Data)
        const lineCtx = document.getElementById('scorecardChart').getContext('2d');
        const gamePointsChart = new Chart(lineCtx, {
            type: 'line',  // Line chart type
            data: {
                labels: allTurnNumbers,  // Turn numbers for x-axis from combined dataset
                datasets: [
                    {
                        label: `${factionData.faction_name} Average`,  // Label for the faction average line chart
                        data: completeFactionGamePoints,  // Average game points for y-axis (faction)
                        borderColor: color,  // Line color for faction average (different color)
                        backgroundColor: color,  // Fill color under the line for faction
                        fill: false,  // Do not fill under the line
                        tension: 0.1  // Smooth curve for faction line
                    },
                    {
                        label: typeName,  // Label for the faction average line chart
                        data: completeTypeGamePoints,  // Average game points for y-axis (faction)
                        borderColor: typeColor,  // Line color for faction average (different color)
                        backgroundColor: typeColor,  // Fill color under the line for faction
                        fill: false,  // Do not fill under the line
                        tension: 0.1,  // Smooth curve for faction line
                        borderDash: [4, 2]
                    },
                    {
                        label: 'All Factions',  // Label for the scorecard line chart
                        data: completeAverageGamePoints,  // Game points for y-axis (scorecard)
                        borderColor: '#000000',  // Line color for scorecard
                        backgroundColor: '#000000',  // Fill color under the line for scorecard
                        fill: false,  // Do not fill under the line
                        tension: 0.1,  // Smooth curve for scorecard line
                        borderDash: [7, 3]  // Make the line dashed with 5px dashes and 5px gaps
                    }
                ]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: false,
                            text: 'Turn Number'  // Label for x-axis
                        },
                        min: minTurnNumber,  // Set the min value for the x-axis
                        max: maxTurnNumber,  // Set the max value for the x-axis
                        ticks: {
                            stepSize: 1  // Ensures each turn number is displayed as a tick
                        }
                    },
                    y: {
                        title: {
                            display: false,
                            text: 'Game Points'  // Label for y-axis
                        },
                        beginAtZero: true  // Start y-axis from 0
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom'  // Move legend to the bottom of the chart
                    }
                }
            }
        });

        // Pie Chart Data Processing (same as before)
        const totalFactionPoints = factionData.totals.total_faction_points;
        const totalCraftingPoints = factionData.totals.total_crafting_points;
        const totalBattlePoints = factionData.totals.total_battle_points;
        const totalOtherPoints = factionData.totals.total_other_points;
        const totalGamePoints = totalFactionPoints + totalCraftingPoints + totalBattlePoints + totalOtherPoints;

        if (totalGamePoints){
        // Prepare data for Pie Chart
        const pieData = {
            labels: [
                'Faction Points',
                'Crafting Points',
                'Battle Points',
                'Other Points'
            ],
            datasets: [{
                data: [
                    totalFactionPoints,
                    totalCraftingPoints,
                    totalBattlePoints,
                    totalOtherPoints
                ],
                backgroundColor: [
                    '#FFCE56',  // Faction Points color
                    '#36A2EB',  // Crafting Points color
                    '#FF6384',  // Battle Points color
                    '#4BC0C0'   // Other Points color
                ],
                hoverBackgroundColor: [
                    '#FFCE56',  // Hover color for Faction Points
                    '#36A2EB',  // Hover color for Crafting Points
                    '#FF6384',  // Hover color for Battle Points
                    '#4BC0C0'   // Hover color for Other Points
                ]
            }]
        };

        // Initialize Pie Chart
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const pieChart = new Chart(pieCtx, {
            type: 'doughnut',  // Pie chart type
            data: pieData,  // Pie chart data
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                // Display percentage in tooltip
                                let percentage = ((tooltipItem.raw / totalGamePoints) * 100).toFixed(2);
                                return `${tooltipItem.label}: ${percentage}%`;
                            }
                        }
                    }
                }
            }
        });

    }else{
        if (pieChartContainer) {
            pieChartContainer.remove();
        }
        const pieDescriptionElement = document.getElementById('pieDescription');
        if (pieDescriptionElement) {
            pieDescriptionElement.remove();  // This will remove the entire element
        }
    }

    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
</script>

{% endblock scripts %}