{% extends "the_keep/base.html" %}
{% load i18n crispy_forms_tags %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a class="btn btn-secondary btn-sm mx-1" href="{% url 'law-of-root' language_code='en' %}"><i class="bi bi-chevron-left"></i> {% trans 'Back to Law' %}</a>
    </div>
    
  
    <a href="{% url 'check-for-law-updates' %}" class="btn btn-outline-secondary text-start">
      <div>
        <i class="bi bi-arrow-repeat"></i> Check for Updates
      </div>
      {% if last_law_check %}
        <small class="d-block" style="font-size: 0.6rem; line-height: 1;">
          Last sync: {{ last_law_check|date:"F j, Y" }}
        </small>
      {% endif %}
    </a>

  </div>
  <h2 class="text-center root-title">Update Laws of Root</h2>
  <hr>
  

{% for language, data in rules_by_language.items %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">{{ language }}</h5>

      <p>
        Active Law: 
        {% if data.active %}
          <strong>{{ data.active }}</strong>
        {% else %}
          <em>No active Law</em>
        {% endif %}
      </p>

      {% if data.new %}
      <form method="post" action="{% url 'activate-rule' %}">
        {% csrf_token %}
        <input type="hidden" name="language" value="{{ language }}">
        
        <div class="input-group mb-2">
          <select name="rule_id" class="form-select rule-select" required>
            <option value="">-- Select a new law file --</option>
            {% for rule in data.new %}
              <option value="{{ rule.id }}">{{ rule }}</option>
            {% endfor %}
          </select>
          <a href="#" class="btn btn-secondary preview-btn ms-1 disabled" target="_blank" aria-disabled="true">View</a>
          <button type="submit" class="btn btn-primary ms-1">Update</button>
          <!-- Archive Rule -->
          <button type="submit"
              formaction="{% url 'archive-rule' %}"
              class="btn btn-warning ms-1">
          Ignore
          </button>
        </div>
      </form>
      {% else %}
      <div class='mb-2'>
      Law is up to date <a href="{% url 'law-preview' data.id %}" class="btn btn-secondary ms-1">View</a>
      </div>
      {% endif %}
    </div>
  </div>
{% endfor %}
{% endblock content %}

{% block scripts %}
<script>
    document.querySelectorAll('.rule-select').forEach(select => {
        const previewBtn = select.parentElement.querySelector('.preview-btn');
        
        select.addEventListener('change', function() {
            const ruleId = this.value;
            if (ruleId) {
                previewBtn.href = "{% url 'law-preview' 0 %}".replace('0', ruleId);
                previewBtn.classList.remove('disabled');
                previewBtn.removeAttribute('aria-disabled');
            } else {
                previewBtn.href = "#";
                previewBtn.classList.add('disabled');
                previewBtn.setAttribute('aria-disabled', 'true');
            }
        });
    });
    
</script>
{% endblock scripts %}