{% extends 'the_keep/base.html' %}
{% load static i18n %}

{% block meta %}    <!-- Open Graph tags -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:image" content="{% static 'images/archive-icon.png' %}">
<meta property="og:site_name" content="Root Database">
<meta property="og:title" content="{{meta_title}}">
<meta property="og:description" content="{{meta_description}}">
<meta name="description" content="{{meta_description}}">
{% endblock meta%}

{% block content %}
<h1 class='root-title'>Advanced Search</h1>

<article class="media content-section">
    <div class="media-body">

        <div class="d-flex flex-wrap justify-content-center" role="group" aria-label="Component type filter">
            {% for tab in tabs %}
                {% if component_type == tab %}
                    <button type="button" class="btn btn-sm btn-secondary m-1">
                        {% if tab == "Tweak" %}
                            House Rule
                        {% else %}
                            {{ tab }}
                        {% endif %}
                    </button>
                {% else %}
                    <a class="btn btn-sm btn-outline-secondary m-1"
                    href="{% url 'advanced-search' component_type=tab|lower %}?search={{search}}&status={{status}}&designer={{selected_designer}}&artist={{selected_artist}}&language_code={{selected_language}}&expansion={{selected_expansion}}&animal={{animal}}&color={{color|urlencode}}">
                        {% if tab == "Tweak" %}
                            House Rule
                        {% else %}
                            {{ tab }}
                        {% endif %}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
        <hr>


        <form id='advanced-search-form' class="mb-2" method="get" action="">

            {% comment %} <input type="text" name="search" placeholder="Search name or animal..." value="{{ search }}"> {% endcomment %}
            <input type="text" name="search" id="search" placeholder="Search by Name..." value="{{ search }}" class="form-control mb-1">
            {% if component_type == "Faction" or component_type == "Hireling" or component_type == "Vagabond" or component_type == "Clockwork" %}
                <input type="text" name="animal" id="animal" placeholder="Search by Animal..." value="{{ animal }}" class="form-control mb-1">
            {% endif %}


            {% if color_choices %}    
            <div class='mb-1'>     
                <select id="color" name="color" class="form-control">
                    <option value="">{% trans 'All Colors' %}</option>
                    {% for color_option in color_choices %}
                        <option value="{{ color_option.value }}" {% if color_option.value == color %}selected{% endif %}>
                            {{ color_option.label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}


            <div>
            <!-- Designer Search Dropdown -->
            <div class='mb-1'>
                <select name="designer" id="designer-select" class="form-select" aria-label="Select Designer">
                    <option value="">{% trans 'Select Designer' %}</option>
                    {% for designer in designers %}
                        <option value="{{ designer.id }}" {% if selected_designer == designer.id|stringformat:"s" %}selected{% endif %}>
                            {{ designer }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% if artists %}
            <div class='mb-1'>
                <select name="artist" id="artist-select" class="form-select" aria-label="Select Artist">
                    <option value="">{% trans 'Select Artist' %}</option>
                    {% for artist in artists %}
                        <option value="{{ artist.id }}" {% if selected_artist == artist.id|stringformat:"s" %}selected{% endif %}>
                            {{ artist }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <label class='root-title'>Status</label>
            <div class="button-select-group" data-target="status">
                <div class="button-option select-option mb-2" data-value="" {% if status == '' %}class="selected"{% endif %}>{% trans 'All' %} -{% if has_status.stable %} <i class="bi bi-check-circle-fill text-success"></i>{% endif %}{% if has_status.testing %} <i class="bi bi-play-circle-fill text-primary"></i>{% endif %}{% if has_status.development %} <i class="bi bi-wrench-adjustable-circle-fill text-warning"></i>{% endif %}{% if has_status.inactive %} <i class="bi bi-dash-circle-fill text-secondary"></i>{% endif %}</div>
                
                {% if has_status.stable %}  
                <div class="button-option select-option mb-2" data-value="1" {% if status == '1' %}class="selected"{% endif %}>
                    <span class="text-success">{% trans 'Stable' %}</span>
                    <i class="bi bi-check-circle-fill text-success"></i>
                </div>
                {% endif %}
                
                {% if has_status.testing %}  
                <div class="button-option select-option mb-2" data-value="2" {% if status == '2' %}class="selected"{% endif %}>
                    <span class="text-primary">{% trans 'Testing' %}</span>
                    <i class="bi bi-play-circle-fill text-primary"></i>
                </div>
                {% endif %}
                
                {% if has_status.development %}  
                <div class="button-option select-option mb-2" data-value="3" {% if status == '3' %}class="selected"{% endif %}>
                    <span class="text-warning">{% trans 'Development' %}</span>
                    <i class="bi bi-wrench-adjustable-circle-fill text-warning"></i>
                </div>
                {% endif %}
                
                {% if has_status.inactive %}  
                <div class="button-option select-option mb-2" data-value="4" {% if status == '4' %}class="selected"{% endif %}>
                    <span class="text-secondary">{% trans 'Inactive' %}</span>
                    <i class="bi bi-dash-circle-fill text-secondary"></i>
                </div>
                {% endif %}
            </div>
            
            <input type="hidden" name="status" id="status" value="{{ status }}">



            <div>
            <div class='mb-1'>
                <select name="language_code" id="language-select" class="form-select" aria-label="Select Language">
                    <option value="">{% trans 'Select Language' %}</option>
                    {% for language in used_languages %}
                        <option value="{{ language.code }}" {% if language.code == selected_language %}selected{% endif %}>
                            {{ language }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% if expansions %}
                <div class='mb-1'>
                    <select name="expansion" id="expansion-select" class="form-select" aria-label="Select Expansion">
                        <option value="">{% trans 'Select Expansion' %}</option>
                        {% for expansion in expansions %}
                            <option value="{{ expansion.id }}" {% if expansion.id|stringformat:"s" == selected_expansion %}selected{% endif %}>
                                {{ expansion }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
        </div>

        </div>


        {% if component_type == "Faction" %}
            {% include "the_keep/partials/adv_search_faction.html" %}
        {% endif %}

        {% if component_type == "Map" %}
            {% include "the_keep/partials/adv_search_map.html" %}
        {% endif %}

        {% if component_type == "Vagabond" %}
            {% include "the_keep/partials/adv_search_vb.html" %}
        {% endif %}

        {% if component_type == "Hireling" %}
            {% include "the_keep/partials/adv_search_hireling.html" %}
        {% endif %}

        {% if component_type == "Deck" %}
            {% include "the_keep/partials/adv_search_deck.html" %}
        {% endif %}

        {% if component_type == "Faction" or component_type == "Vagabond" or component_type == "Clockwork" %}
        <h3 class='root-title'>Winrate</h3>
          <div class="d-flex align-items-center gap-3">
            <span class="mr-4" id="winrate_min_display">0%</span>
            
            <div id="winrate-slider" style="flex-grow: 1;"></div>
            
            <span class="ml-4" id="winrate_max_display">100%</span>
          </div>
          
          <!-- Hidden fields for the actual form submission -->
          <input type="hidden" name="winrate_min" id="winrate_min">
          <input type="hidden" name="winrate_max" id="winrate_max">
          
        {% endif %}

        <!-- Games played -->
        {% include "the_keep/partials/adv_quantity_filter.html" with prefix="games" label="Games Played" op=games_op qty=games_qty %}

        {% if has_piece_type.warrior or has_piece_type.building or has_piece_type.token or has_piece_type.card or has_piece_type.other %}
            {% include "the_keep/partials/adv_search_pieces.html" %}
        {% endif %}
          
          <div class="mt-3">
            <button type="button" id="clear-filters" class="btn btn-sm btn-secondary">
                <i class="bi bi-x-circle"></i> {% trans 'Clear' %}
            </button>

            <button type="submit" class="btn btn-sm btn-primary">
                <i class="bi bi-search"></i> {% trans 'Search' %}
            </button>
            {% if user.is_authenticated and not user.profile.weird %}
                <div>
                    <small>*Displaying Official Content Only</small>
                </div>
            {% endif %}
        </div>
        
        </form>

    </div>
</article>



    {% include 'the_keep/partials/advanced_search_results.html' %}


{% endblock content %}

{% block scripts %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">

<script>
  const slider = document.getElementById('winrate-slider');
  const initialColor = "{{ theme.theme_color }}";
  const lightColors = ['#ffffff', '#ffff00', '#ffc0cb']; // white, yellow and pink

  document.addEventListener("DOMContentLoaded", function () {
    if (!slider) return; // Exit if the slider doesn't exist
  
    // DOM references for slider values
    const minDisplay = document.getElementById("winrate_min_display");
    const maxDisplay = document.getElementById("winrate_max_display");
    const minInput = document.getElementById("winrate_min");
    const maxInput = document.getElementById("winrate_max");
  
    // Create the slider
    noUiSlider.create(slider, {
      start: [{{ winrate_min|default:0 }}, {{ winrate_max|default:100 }}],
      connect: true,
      step: 1,
      range: {
        min: 0,
        max: 100
      },
      format: {
        to: value => Math.round(value),
        from: value => Number(value)
      }
    });
  
    // Handle slider updates
    slider.noUiSlider.on('update', function (values) {
      const [minVal, maxVal] = values;
  
      if (minDisplay) minDisplay.textContent = `${minVal}%`;
      if (maxDisplay) maxDisplay.textContent = `${maxVal}%`;
  
      if (minInput) minInput.value = minVal;
      if (maxInput) maxInput.value = maxVal;
    });
  });
  

  //Submit form without blank values
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        form.addEventListener("submit", function (e) {
            const inputs = form.querySelectorAll("input, select");
            inputs.forEach(input => {
                if (input.value === "") {
                    input.disabled = true;  // Disabled fields are not submitted
                }
            });
        });
    });


    // Change color of elements
    document.addEventListener("DOMContentLoaded", function () {
        const colorSelect = document.getElementById("color");
    
        // Only run the color logic if the slider exists
        if (!slider) {
            return; // Exit early if the slider isn't on the page
        }
    

    
        function updateSliderColor(hexColor) {
            const connect = slider.querySelector('.noUi-connect');
            if (connect) {
                connect.style.backgroundColor = hexColor;
            }
        
            // Update bar colors
            const bars = document.querySelectorAll('.bar-background');
            bars.forEach(bar => {
                bar.style.setProperty('--bar-color', hexColor);
            });
        
            // Add or remove black text for light colors        
            const lowerHex = hexColor.toLowerCase(); // normalize
            const useBlackText = lightColors.includes(lowerHex);
        
            // Only apply to Low, Moderate, High bars
            const barClassesToCheck = ['bar-background-low', 'bar-background-moderate', 'bar-background-high'];
        
            bars.forEach(bar => {
                if (barClassesToCheck.some(cls => bar.classList.contains(cls))) {
                    const text = bar.querySelector('.bar-text');
                    if (text) {
                        if (useBlackText) {
                            text.classList.add('bar-black-text');
                        } else {
                            text.classList.remove('bar-black-text');
                        }
                    }
                }
            });
        }
        
    
        // Set color on load
        const currentColor = colorSelect?.value || initialColor;
        updateSliderColor(currentColor);
    
        // Update color when dropdown changes
        colorSelect?.addEventListener("change", function () {
            const selectedColor = this.value;
            updateSliderColor(selectedColor || initialColor);
        });
    });
    
    

    function clearButtonSelectField(fieldName) {
        // Clear the hidden input
        const input = document.getElementById(fieldName);
        if (input) {
          input.value = "";
        }
      
        // Find the button/select group
        const group = document.querySelector(`.button-select-group[data-target='${fieldName}']`);
        if (group) {
          group.querySelectorAll(".button-option, .select-option").forEach(option => {
            option.classList.remove("selected");
          });
      
          // Re-select the "All" option (data-value="")
          const allOption = group.querySelector('[data-value=""]');
          if (allOption) {
            allOption.classList.add("selected");
          }
        }
      }
      
      

    
    document.getElementById("clear-filters").addEventListener("click", function () {
        const form = document.querySelector("form");

        // Clear all text/select inputs
        form.querySelectorAll("input, select").forEach(input => {
          if (input.type !== "hidden") {
            input.value = "";
          }
        });

        // Clear all Select2 fields
        if (window.jQuery && jQuery().select2) {
            jQuery(form)
            .find("select.select2-hidden-accessible") // all active Select2 elements
            .each(function () {
                jQuery(this).val(null).trigger("change"); // clear and refresh UI
            });
        }

        ["status", "faction_type", "hireling_type", "ability_item"].forEach(clearButtonSelectField);

        // Reset all bar click zones to "Any"
        document.querySelectorAll(".bar-click-zone").forEach(zone => {
          updateBarState(zone, states[0]); // "Any" is first in your states array
        });
        // Reset the color of all bars
        document.querySelectorAll('.bar-background').forEach(bar => {
            bar.style.setProperty('--bar-color', initialColor);
        });
        // Reset the winrate slider if it exists
        if (typeof slider !== "undefined" && slider.noUiSlider) {
          slider.noUiSlider.set([0, 100]);
          const connect = slider.querySelector('.noUi-connect');
          if (connect) {
            connect.style.backgroundColor = initialColor;
          }
        }
        //form.submit();
      });
      

    // Function for updating button select groups (militatnt/insurgent, status etc.)
    document.addEventListener('DOMContentLoaded', function () {
        const groups = document.querySelectorAll('.button-select-group');
    
        groups.forEach(group => {
            const targetInputId = group.getAttribute('data-target');
            const hiddenInput = document.getElementById(targetInputId);
            const currentValue = hiddenInput.value;
            const options = group.querySelectorAll('.select-option');
    
            // Pre-select based on current value
            options.forEach(option => {
                if (option.dataset.value === currentValue) {
                    option.classList.add('selected');
                }
    
                option.addEventListener('click', function () {
                    // Clear existing selection
                    options.forEach(opt => opt.classList.remove('selected'));
    
                    // Mark this one as selected
                    this.classList.add('selected');
    
                    // Update hidden input
                    hiddenInput.value = this.dataset.value;
                });
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        const designerSelect = document.getElementById('designer-select');
        if (designerSelect) {
        $('#designer-select').select2({
            placeholder: 'Select Designer',
            allowClear: true,
            width: '100%'
        });
        }

        const artistSelect = document.getElementById('artist-select');
        if (artistSelect) {
        $('#artist-select').select2({
            placeholder: 'Select Artist',
            allowClear: true,
            width: '100%'
        });
        }

        const expansionSelect = document.getElementById('expansion-select');
        if (expansionSelect) {
        $('#expansion-select').select2({
            placeholder: 'Select Expansion',
            allowClear: true,
            width: '100%'
        });
        }

        const languageSelect = document.getElementById('language-select');
        if (languageSelect) {
        $('#language-select').select2({
            placeholder: 'Select Language',
            allowClear: true,
            width: '100%'
        });
        }

        {% comment %} const colorSelect = document.getElementById('color');
        if (colorSelect) {
        $('#color').select2({
            placeholder: 'Select Color',
            allowClear: true,
            width: '100%'
        });
        } {% endcomment %}


    });
    </script>
    

{% endblock scripts %}