{% load crispy_forms_tags %}

<form action="." method="POST" hx-swap="outerHTML">
    {% csrf_token %}

    
    <h2>Game Details</h2>
        <div id="game-tournament-field">
                {{ form.round.label_tag }} {{ form.round }}
        </div>
        <div id="game-platform-field">
                {{ form.platform.label_tag }} {{ form.platform }}
        </div>
        <div class="timing-field" id="timing-field" {% if object.platform != "Root Digital" %}style="display:none;"{% endif %}>
                {{ form.type.label_tag }} {{ form.type }}
        </div>
        <div id="game-deck-field">
                {{ form.deck.label_tag }} {{ form.deck }}
        </div>
        <div id="game-map-field">
                {{ form.map.label_tag }} {{ form.map }}
        </div>

        <div id="game-landmarks-field">
                {{ form.landmarks.label_tag }} {{ form.landmarks }}
        </div>
        <div class="hireling-field" id="hireling-field">
                {{ form.hirelings.label_tag }} {{ form.hirelings }}
        </div>
        <div id="game-undrafted_faction-field">
                {{ form.undrafted_faction.label_tag }} {{ form.undrafted_faction }}
        </div>
        <div class="undrafted-vagabond-field" id="undrafted-vagabond-field" style="display:none;">
                {{ form.undrafted_vagabond.label_tag }} {{ form.undrafted_vagabond }}
        </div>


        <h2>Players</h2>
        <div class="hidden">{{ formset.management_form }}</div>
        <div id="effort-form-list">
                {% for form in formset %}
                        <div id="form-{{ forloop.counter0 }}" class="effort-form form-control">


                        
                        <div class="player-field">Player: {{ form.player }}</div>    
                        <div class="faction-field">Faction: {{ form.faction }}</div>
                        <div class="vagabond-field" style="display:none;">Vagabond: {{ form.vagabond }}</div>
                        <div class="captains-field" style="display:none;">Captains: {{ form.captains }}</div>
                        <div class="score-field">Score: {{ form.score }}</div>
                        <div class="win-field">Win: {{ form.win }}</div>
                        <div class="coalition-field" style="display:none;">Coalition: {{ form.coalition_with }}</div>
                        <div class="dominance-field">Dominance: {{ form.dominance }}</div>

                        {% if not form.instance.id %}
                                <button class="btn btn-warning btn-sm" type="button"
                                        onclick="clearForm(this)">
                                        Remove
                                </button>
                        {% else %}
                                <div class="id-field" style="display:none;">{{ form.id }}</div>
                        {% endif %}

                        </div>

                        {% if form.errors %}
                        <div class="alert alert-warning mt-1" role="alert">
                                <ul>
                                {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                {% endfor %}
                        </ul>
                        </div>
                        {% endif %}
                {% endfor %}
        </div>

        <div id="empty-form" class="hidden effort-form form-control">
                {% for field in formset.empty_form  %}
                        {% include 'the_warroom/partials/effort_field_form.html' %}
                {% endfor %}
                <button class="btn btn-warning btn-sm" type="button"
                        onclick="clearForm(this)">
                        Remove
                </button>
        </div>

        <div class="mt-2" id="game-link-field">
                {{ form.link.label_tag }} {{ form.link }}
        </div>

    <button class="btn btn-info mb-2 mt-2" id="add-more" type="button">Add Player +</button>
    <div class="htmx-indicator mb-2 mt-2">Loading...</div>
    <button class="btn btn-success htmx-inverted-indicator mb-2 mt-2" type="submit">Save</button>
    {% if object.id %}
        <a class="btn btn-danger mb-2 mt-2" href="{{ object.get_delete_url }}">Delete</a>
    {% else %}
        <a class="btn btn-secondary mb-2 mt-2"  href="{% url 'games-home' %}">Cancel</a>
    {% endif %}
    {% if message %}
        <p>{{ message }}</p>
    {% endif %}

    
    </form>

    

    <h5 class="d-inline-flex align-items-center">Register New Player
        <button class="btn btn-primary btn-sm ml-2 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRegister" aria-expanded="false" aria-controls="collapseRegister">
                <i class="bi bi-chevron-double-down"></i>
        </button>
    </h5>
      <div class="collapse" id="collapseRegister">
        <div class="card card-body">
                
                <div id="player-form-container" style="display: block;">
                        <form id="register-form" hx-post="{% url 'add-discord-player' %}" hx-trigger="submit" hx-target="#player-form-errors" hx-swap="none">
                            {% csrf_token %}
                            {{ player_form.discord.label }}:
                            {{ player_form.discord }}
                            <button type="submit" class="btn btn-primary btn-sm">Register Player</button>
                        </form>
                </div>
                
                <div id="player-form-errors"><small>If a player is missing you can add them here.</small></div>        
        </div>
      </div>