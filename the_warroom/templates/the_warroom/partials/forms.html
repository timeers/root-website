{% load crispy_forms_tags %}

<form action="." method="POST" hx-swap="outerHTML">
    {% csrf_token %}

    
    <h2>Game Details</h2>
    {% for field in form %}
        {% if field.label == 'Undrafted vagabond' %}
                <div class="undrafted-vagabond-field" id="undrafted-vagabond-field" style="display:none;">
                        {{ field.errors }}
                        {{ field.label_tag }} {{ field }}
                        {% if field.help_text %}
                                <p class="help">{{ field.help_text | safe }}</p>
                        {% endif %}
                </div>
        {% elif field.label == 'League' %}
                <div class="league-field" style="display:none;">
                        {{ field.errors }}
                        {{ field.label_tag }} {{ field }}
                        {% if field.help_text %}
                                <p class="help">{{ field.help_text | safe }}</p>
                        {% endif %}
                </div>
        {% elif field.label == 'Random clearing' %}
                <div class="rc-field" style="display:none;">
                        {{ field.errors }}
                        {{ field.label_tag }} {{ field }}
                        {% if field.help_text %}
                                <p class="help">{{ field.help_text | safe }}</p>
                        {% endif %}
                </div>
        {% elif field.label == 'Type' %}
                <div class="timing-field" id="timing-field" {% if object.platform != "Root Digital" %}style="display:none;"{% endif %}>
                        {{ field.errors }}
                        {{ field.label_tag }} {{ field }}
                        {% if field.help_text %}
                                <p class="help">{{ field.help_text | safe }}</p>
                        {% endif %}
                </div>
        {% elif field.label == 'Hirelings' %}
        <div class="hireling-field" id="hireling-field" {% if object.platform == "Root Digital" %}style="display:none;"{% endif %}>
                {{ field.errors }}
                {{ field.label_tag }} {{ field }}
                {% if field.help_text %}
                        <p class="help">{{ field.help_text | safe }}</p>
                {% endif %}
        </div>

        {% else %}
            <div id="game-{{ field.label.lower }}-field" class="{% if field.field.required %}{{ form.required_css_class }}{% endif %}">
                
            {{ field.errors }}
            {{ field.label_tag }} {{ field }}
            {% if field.help_text %}
                    <p class="help">{{ field.help_text | safe }}</p>
            {% endif %}
            </div>
        {% endif %}
    {% endfor %}


        <h2>Players</h2>
        {{ formset.management_form }}
        <div id="effort-form-list">
                {% for form in formset %}
                        <div id="form-{{ forloop.counter0 }}" class="effort-form form-control">
                        {% for field in form %}
                                {% include 'the_warroom/partials/effort_field_form.html' %}
                        {% endfor %}

                        {% if not form.instance.id %}
                                <button class="btn btn-outline-warning btn-sm" type="button"
                                        onclick="clearForm(this)">
                                        Remove
                                </button>
                        {% endif %}

                        </div>
                {% endfor %}
        </div>

        <div id="empty-form" class="hidden effort-form form-control">
                {% for field in formset.empty_form  %}
                        {% include 'the_warroom/partials/effort_field_form.html' %}
                {% endfor %}
                <button class="btn btn-outline-warning btn-sm" type="button"
                        onclick="clearForm(this)">
                        Remove
                </button>
        </div>



    <button class="btn btn-outline-info mb-2 mt-2" id="add-more" type="button">Add Player +</button>
    <div class="htmx-indicator mb-2 mt-2">Loading...</div>
    <button class="btn btn-outline-success htmx-inverted-indicator mb-2 mt-2" type="submit">Save</button>
    {% if object.id %}
        <a class="btn btn-outline-danger mb-2 mt-2" href="{{ object.get_delete_url }}">Delete</a>
    {% else %}
        <a class="btn btn-outline-info mb-2 mt-2"  href="{% url 'games-home' %}">Cancel</a>
    {% endif %}
    {% if message %}
        <p>{{ message }}</p>
    {% endif %}

    
    </form>

    

    <h5 class="d-inline-flex align-items-center">Register New Player
        <button class="btn btn-primary btn-sm ml-2 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRegister" aria-expanded="false" aria-controls="collapseRegister">
                <i class="bi bi-chevron-double-down"></i>
        </button>
    </h5>
      <div class="collapse" id="collapseRegister">
        <div class="card card-body">
                
                <div id="player-form-container" style="display: block;">
                        <form id="register-form" hx-post="{% url 'add-discord-player' %}" hx-trigger="submit" hx-target="#player-form-errors" hx-swap="none">
                            {% csrf_token %}
                            {{ player_form.discord.label }}:
                            {{ player_form.discord }}
                            <button type="submit" class="btn btn-primary btn-sm">Register Player</button>
                        </form>
                </div>
                
                <div id="player-form-errors"><small>If a player is missing you can add them here.</small></div>        
        </div>
      </div>