{% extends 'the_keep/base.html' %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center;">
<h1>{% if object.id %}Update{% else %}Record{% endif %} Detailed Game Scores</h1>
    <button class="btn btn-outline-info btn-sm ml-2 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRegister" aria-expanded="false" aria-controls="collapseRegister">
        <i class="bi bi-info-circle"></i>
    </button>
</div>   


<div class="collapse" id="collapseRegister">
    <div class="card card-body">
                        
            <div id="scorecard-info"><small>Record turn by turn point details for a faction. This is optional but can provide some insight into a faction's scoring pace and how they score points.<br>
                'Faction Points' are points scored or lost from your faction abilities, 'Crafting Points' are from items crafted, 'Battle Points' are from removing buildings and tokens in battle, and 'Other Points' are for everything else.<br>
                If you do not wish to break points down by category, use the 'Other Points' column.
            </small></div>        
    </div>
  </div>
<style>
        .turn-form {
                border-bottom: 1px solid black;
        }
        .hidden {
                display: None ;
        }

        .turn-header, .turn-form {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .turn-column {
        flex: 1; /* Makes each column take equal width */
        padding: 5px;
        text-align: center; /* Center-align text */
    }

    .turn-column input,
    .turn-column select,
    .turn-column span {
        width: 100%; /* Ensure form fields span the full column width */
    }

    .hidden {
        display: none;
    }

    #turn-form-list {
        max-width: 100%;
        overflow-x: auto;
    }

    /* Additional styling to make buttons and inputs look nice */
    .btn {
        margin-top: 15px;
    }

    .turn-column.total-points {
        font-weight: bold;
    }
    .total-row {
        font-weight: bold;
    }



</style>
<div style="margin-top: 30px;">

    <form method="POST">
        {% csrf_token %}
    

    <div id="game-faction-select" class="{{ form.required_css_class }}" {% if object.id %}disabled{% endif %}>
        <h4>Faction:</h4>
        {{ form.faction }}
    </div>

    <h4>
        Turns{% if score %} ({{ score }} points){% endif %}:
    </h4>
    {% if message %}
        <div class="alert alert-warning" role="alert">
            {{ message }}
        </div>
    {% endif %}
    <div class="hidden">{{ formset.management_form }}</div>
    

    <div id="form-turn-list">
        <div class="turn-header">
            <div class="turn-column">Turn</div>
            <div class="turn-column">Faction Points</div>
            <div class="turn-column">Crafting Points</div>
            <div class="turn-column">Battle Points</div>
            <div class="turn-column">Other Points</div>
            <div class="turn-column">Total Points</div>
            <div class="turn-column dom-column hidden" id="id_dominance-column">Dom</div>
        </div>

        {% for form in formset %}
            <div id="form-{{ forloop.counter0 }}" class="turn-form">
                <div class="turn-column">
                    {{ forloop.counter0|add:1 }}
                    <input type="hidden" name="form-{{ forloop.counter0 }}-turn_number" value="{{ forloop.counter0|add:1 }}" 
                    id="id_form-{{ forloop.counter0 }}-turn_number"/>
                    {% if form.instance.id %}
                        <input type="hidden" name="form-{{ forloop.counter0 }}-id" value="{{ form.instance.id }}" 
                        id="id_form-{{ forloop.counter0 }}-id"/>
                    {% endif %}

                </div>
                <div class="turn-column">{{ form.faction_points }}</div>
                <div class="turn-column">{{ form.crafting_points }}</div>
                <div class="turn-column">{{ form.battle_points }}</div>
                <div class="turn-column">{{ form.other_points }}</div>
                <div class="turn-column total-points" id="total-points-{{ forloop.counter0 }}">0</div>
                <div class="turn-column dom-column hidden">{{ form.dominance }}</div>
            </div>
        {% endfor %}

        <div id="total-row" class="turn-form total-row">
            <div class="turn-column">Totals</div>
            <div id="total-faction" class="turn-column">0</div>
            <div id="total-crafting" class="turn-column">0</div>
            <div id="total-battle" class="turn-column">0</div>
            <div id="total-other" class="turn-column">0</div>
            <div id="total-total" class="turn-column">0</div>
            <div id="total-dominance" class="turn-column dom-column hidden"></div>
        </div>

    </div>

    <div id="empty-form" class="hidden">
        <div class="turn-column">
            <input type="hidden" name="form-__prefix__-turn_number" value="0" 
                    id="id_form-__prefix__-turn_number"/>
        </div>
        <div class="turn-column">{{ formset.empty_form.faction_points }}</div>
        <div class="turn-column">{{ formset.empty_form.crafting_points }}</div>
        <div class="turn-column">{{ formset.empty_form.battle_points }}</div>
        <div class="turn-column">{{ formset.empty_form.other_points }}</div>
        <div class="turn-column total-points" id="total-points-__prefix__">0</div>
        <div class="turn-column dom-column hidden">{{ formset.empty_form.dominance }}</div>
    </div>
    <button class="btn btn-outline-info btn-sm mb-2 mt-2" id="add-more" type="button">Add Turn +</button>
    <button class="btn btn-outline-danger btn-sm mb-2 mt-2" id="remove-turn" type="button">Remove Turn</button>
    <button class="btn btn-outline-warning btn-sm mb-2 mt-2" id="toggle-dominance" type="button">Play Dominance</button>
    <div id="game-description-field">
        <h4>Notes:</h4>{{ form.description }}
    </div>

    <button class="btn btn-outline-success mb-2 mt-2" type="submit">Save</button>
    {% if object.id %}
        <a class="btn btn-outline-secondary mb-2 mt-2" href="{% url 'detail-scorecard' object.id %}">Cancel</a>
        <a class="btn btn-outline-danger mb-2 mt-2" href="{% url 'delete-scorecard' object.id %}">Delete</a>
    {% else %}
        <a class="btn btn-outline-info mb-2 mt-2" href="{% url 'games-home' %}">Cancel</a>
    {% endif %}

    </form>
</div>


        

{% endblock content %}



{% block scripts %}
<script>
$(document).ready(function () {
    $('#id_faction').select2();

    // Initial index for adding new forms
    let nextFormIndex = parseInt($('#id_form-TOTAL_FORMS').val(), 10);
    const startingIndex = nextFormIndex
    const removeFormEl = document.getElementById('remove-turn');
    const addFormEl = document.getElementById('add-more');

    show_hide_remove()
    setInitialDominance()

    // Click event to add a new form
    document.addEventListener('click', (event) => {
        if (event.target.id == 'add-more') {
            add_new_form(event);
        }
        if (event.target.id == 'remove-turn') {
            remove_last_turn(event);
        }
        if (event.target.id == 'toggle-dominance') {
            toggle_dominance(event);
        }
    });


    function remove_last_turn(event){
        if (event) {
            event.preventDefault();
        }
        const formCopyTarget = document.getElementById("form-turn-list");
        const lastChild = formCopyTarget.lastElementChild;
        const secondToLastChild = formCopyTarget.children[formCopyTarget.children.length - 2];
        const secondChild = formCopyTarget.children[1];
        // Remove the second-to-last child if it exists
        if (secondToLastChild && secondToLastChild !== secondChild && nextFormIndex > startingIndex) {
            formCopyTarget.removeChild(secondToLastChild);
            // Update the total form count after removing a form
            const totalNewForms = document.getElementById('id_form-TOTAL_FORMS');
            totalNewForms.value = parseInt(totalNewForms.value, 10) - 1;
            nextFormIndex--;
            show_hide_remove()
        }else {
            // If there is no second-to-last child, log a message
            console.log("Unable to remove turn. Contact admin or delete and start over.");
        }
        const turnRows = document.querySelectorAll('[id$="-turn_number"]');
        turnRows.forEach((turnRow, index) => {
            if (index < turnRows.length - 1) {
                calculateTotalPoints(turnRow);
            }
        });


    }

    function add_new_form(event) {
        if (nextFormIndex < 30){
            if (event) {
                event.preventDefault();
            }

            // Get the total number of forms
            const totalNewForms = document.getElementById('id_form-TOTAL_FORMS');
            const formCopyTarget = document.getElementById("form-turn-list");
            const lastChild = formCopyTarget.lastElementChild;
            const secondToLastChild = formCopyTarget.children[formCopyTarget.children.length - 2];
            const domButton = document.getElementById("toggle-dominance")

            // Clone the empty form
            const copyEmptyFormEl = document.getElementById('empty-form').cloneNode(true);

            // Remove the hidden class to make it visible
            copyEmptyFormEl.classList.remove('hidden');

            // Update the class and ID of the cloned form
            copyEmptyFormEl.setAttribute('class', 'turn-form');
            copyEmptyFormEl.setAttribute('id', `form-${nextFormIndex}`);

            // Replace the __prefix__ in all form field names with the correct index
            const regex = new RegExp('__prefix__', 'g');
            copyEmptyFormEl.innerHTML = copyEmptyFormEl.innerHTML.replace(regex, nextFormIndex);

            // Update the value of the turn_number field for the cloned form
            const turnNumberInput = copyEmptyFormEl.querySelector('input[name="form-' + nextFormIndex + '-turn_number"]');
            if (turnNumberInput) {
                turnNumberInput.value = nextFormIndex + 1;  // Set the value of turn_number to nextFormIndex + 1

                // Create a new span element to display the turn number above the input
                const turnNumberDisplay = document.createElement('span');
                turnNumberDisplay.classList.add('turn-number-display');
                turnNumberDisplay.textContent = `${nextFormIndex + 1}`;  // Display the turn number

                // Insert the turn number display above the turn_number input
                turnNumberInput.parentNode.insertBefore(turnNumberDisplay, turnNumberInput);



            }

            const dominanceInput = copyEmptyFormEl.querySelector('input[name="form-' + nextFormIndex + '-dominance"]');
            if (dominanceInput && domButton.value === 'enabled') {
                dominanceInput.checked = true
            }


            // Correctly update the form field names to match Django's expectations
            $(copyEmptyFormEl).find('input, select, span').each(function() {
                var name = $(this).attr('name');
                if (name) {
                    $(this).attr('name', name.replace('__prefix__', nextFormIndex));
                }
                var id = $(this).attr('id');
                if (id) {
                    $(this).attr('id', id.replace('__prefix__', nextFormIndex));
                }
            });

            // Append the cloned form to the target form list
            formCopyTarget.insertBefore(copyEmptyFormEl, lastChild);
            // formCopyTarget.append(copyEmptyFormEl);

            // Increment the form count
            totalNewForms.value = nextFormIndex + 1;

            // Increment the form index for the next addition
            nextFormIndex++;

            show_hide_remove()
        }

    }



    function show_hide_remove(){
        if (nextFormIndex > startingIndex){
            removeFormEl.classList.remove('hidden');
        }else{
            removeFormEl.classList.add('hidden');
        }
        if (nextFormIndex > 29){
            addFormEl.classList.add('hidden');
        }else{
            addFormEl.classList.remove('hidden');
        }
    }




    const formTurnList = document.getElementById("form-turn-list");



    const turnRows = document.querySelectorAll('[id$="-turn_number"]');
    turnRows.forEach((turnRow, index) => {
        if (index < turnRows.length - 1) {
            calculateTotalPoints(turnRow);
        }
    });


    // Add event listener to listen for any input change within the turn columns
    formTurnList.addEventListener("input", function(event) {
        // Check if the event target is an input element inside a turn column
        if (event.target && event.target.matches(".turn-column input")) {
            calculateTotalPoints(event.target);
        }
        // Check for Dom changes
        if (event.target && event.target.matches(".dom-column input")) {
            selectDominance(event.target);
        }
    });

    // Function to calculate total points for each turn
    function calculateTotalPoints(inputElement) {
        const turnForm = inputElement.closest('.turn-form'); // Find the closest turn form
        const factionPoints = parseFloat(turnForm.querySelector('[name*="faction_points"]').value) || 0;
        const craftingPoints = parseFloat(turnForm.querySelector('[name*="crafting_points"]').value) || 0;
        const battlePoints = parseFloat(turnForm.querySelector('[name*="battle_points"]').value) || 0;
        const otherPoints = parseFloat(turnForm.querySelector('[name*="other_points"]').value) || 0;

        const totalPoints = factionPoints + craftingPoints + battlePoints + otherPoints;

        // Update the total points display in the current turn form
        const totalPointsElement = turnForm.querySelector('.total-points');
        if (totalPointsElement) {
            totalPointsElement.textContent = totalPoints;
        }

        // Optionally, update the overall totals (if applicable)
        updateOverallTotals();
    }

    // Function to update the overall totals (faction, crafting, battle, other, total)
    function updateOverallTotals() {
        let totalFaction = 0;
        let totalCrafting = 0;
        let totalBattle = 0;
        let totalOther = 0;
        let grandTotal = 0;

        // Loop over all turn forms and sum up the points
        const turnForms = formTurnList.querySelectorAll('.turn-form');
        turnForms.forEach(turnForm => {
            const factionPointsField = turnForm.querySelector('[name*="faction_points"]');
            const craftingPointsField = turnForm.querySelector('[name*="crafting_points"]');
            const battlePointsField = turnForm.querySelector('[name*="battle_points"]');
            const otherPointsField = turnForm.querySelector('[name*="other_points"]');

            // Check if the fields exist before parsing
            if (factionPointsField && craftingPointsField && battlePointsField && otherPointsField) {
                const factionPoints = parseFloat(factionPointsField.value) || 0;
                const craftingPoints = parseFloat(craftingPointsField.value) || 0;
                const battlePoints = parseFloat(battlePointsField.value) || 0;
                const otherPoints = parseFloat(otherPointsField.value) || 0;

                totalFaction += factionPoints;
                totalCrafting += craftingPoints;
                totalBattle += battlePoints;
                totalOther += otherPoints;
                grandTotal += factionPoints + craftingPoints + battlePoints + otherPoints;
            }
        });


        // Update the total rows
        document.getElementById("total-faction").textContent = totalFaction;
        document.getElementById("total-crafting").textContent = totalCrafting;
        document.getElementById("total-battle").textContent = totalBattle;
        document.getElementById("total-other").textContent = totalOther;
        document.getElementById("total-total").textContent = grandTotal;
    }

    // Automatically select the current value when clicking into any of the input fields for points
    $('.turn-column input').on('focus', function() {
        this.select();  // Selects the text inside the input field when focused
    });


    function setInitialDominance(){
        const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="id_form-"]');
        const domColumns = document.querySelectorAll('.dom-column');
        const domButton = document.getElementById("toggle-dominance")
        let initialDom = false
        checkboxes.forEach(function(checkbox) {
                if (checkbox.checked) {
                    initialDom = true
                }
            });
        if (initialDom){
            domColumns.forEach(function(element) {
                element.classList.remove('hidden');
            });
            domButton.innerText = "Undo Dominance";
            domButton.value = "enabled"; 
        }else{
            domColumns.forEach(function(element) {
                element.classList.add('hidden');
            });
        }
    }

    // Dominance Functions
    function toggle_dominance(event){
        if (event) {
            event.preventDefault();
        }
        const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="id_form-"]');
        const dominanceColumn = document.getElementById("id_dominance-column")
        const domColumns = document.querySelectorAll('.dom-column');

        // Hide/unhide column
        if (dominanceColumn.classList.contains('hidden')) {
            domColumns.forEach(function(element) {
                element.classList.remove('hidden');
            });
            // Add dominance to last turn
            const lastCheckbox = checkboxes[checkboxes.length - 2];
            if (lastCheckbox) {
                lastCheckbox.checked = true;
            }
            event.target.innerText = "Undo Dominance";
            event.target.value = "enabled"; 
        } else {
            domColumns.forEach(function(element) {
                element.classList.add('hidden');
            });
            // Remove Dominance from each turn
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = false; 
            });
            event.target.innerText = "Play Dominance";
            event.target.value = "disabled"; 
        }
        
    }

    function selectDominance(inputElement){
        const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="id_form-"]');
        const currentId = inputElement.id;
        const currentNumber = parseInt(currentId.split('-')[1]);
        const emptyFormDom = document.getElementById("id_form-__prefix__-dominance")
        if(inputElement.checked)
            {
                // Loop through all checkboxes and add check to future turns
                checkboxes.forEach(function(checkbox) {
                    const checkboxId = checkbox.id;
                    const checkboxNumber = parseInt(checkboxId.split('-')[1]);

                    if (checkboxNumber > currentNumber && checkbox.checked === false) {
                        // console.log(`Turn ${checkboxNumber + 1} added Dominance`);
                        checkbox.checked = true; 
                    }
                });
                emptyFormDom.checked = true
            }
        else
            {
                // Loop through all checkboxes and remove check from prior turns
                checkboxes.forEach(function(checkbox) {
                    const checkboxId = checkbox.id;
                    const checkboxNumber = parseInt(checkboxId.split('-')[1]);

                    if (checkboxNumber < currentNumber && checkbox.checked === true) {
                        // console.log(`Turn ${checkboxNumber + 1} removed Dominance`);
                        checkbox.checked = false; 
                    }
                });
            }
    }


});





</script>



{% endblock %}