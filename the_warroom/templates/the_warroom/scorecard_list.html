{% extends 'the_keep/base.html' %}
{% load i18n %}
{% block title %} - Scorecards{% endblock %}
{% block content %}


<div style="display: flex; justify-content: space-between; align-items: center;">
        
    <div class='d-flex'>
        <h1>Scorecards</h1>

    </div>  
    <div class='d-flex'>
        {% if user.profile.admin %}
        <a href="{% url 'tournaments-home' %}" class="btn btn-sm btn-primary ml-1 mb-3" id="series">
            Series
        </a>
        {% endif %}

        <a href="{% url 'games-home' %}" class="btn btn-sm btn-primary ml-1 mb-3" id="games">
            Games
        </a>


        {% if user.profile.player %}
            <a class="btn btn-sm btn-success mb-3 ml-1" href="{% url 'record-scorecard' %}">New Scorecard +</a>
        {% endif %}
    </div>
</div>

{% if unassigned_scorecards %}

<div style="display: flex; justify-content: space-between; align-items: center;">
    <h3>Unassigned Scorecards ({{ unassigned_count }})</h3>
    <button class="btn btn-info btn-sm ml-2 ms-2" 
        type="button" 
        data-bs-toggle="collapse" 
        data-bs-target="#collapseRegister" 
        aria-expanded="false" 
        aria-controls="collapseRegister" 
        id="collapseToggleButton">
    View
    </button>
    </div>   
    
    
    <div class="collapse" id="collapseRegister">

        These scorecards have not been linked with a game:

        <article class="media content-section">
            <div class="media-body">
        <table>
            <thead>
                <tr>
                    <th>{% trans 'Faction' %}</th>
                    <th style="text-align: center;">Points</th>
                    <th style="text-align: center;">Turn</th>
                    <th>Game</th>
            
                </tr>
            </thead>
            <tbody class="effort-rows">
                {% for object in unassigned_scorecards %}
                <tr data-href="{{ object.get_absolute_url }}">
                    <td>
                        <img class="faction-icon" src="{{ object.faction.small_icon.url }}">
                        {{  object.faction }}
                    </td>
                    <td style="text-align: center;">
                        {{ object.total_points }}
                    </td>
                    <td style="text-align: center;">
                        {{ object.turns.count }}
                    </td>

                    <td>
                        {% if object.effort.game.nickname %}
                            {{object.effort.game.nickname}}
                        {% else %}
                            {{ object.game_group }}
                        {% endif %}
                    </td>
                </tr>

                {% endfor %}

            </tbody>
        </table>
        </div>
        </article>


    </div>

{% endif %}





{% if complete_scorecards %}
<div class="content-section" id="scorecardContainer">
    <h3>Your Recorded Average by Faction</h3>
<div>
    <canvas id="scorecardChart" width="400" height="400"></canvas>
</div>
<small>*Based on the data you've recorded. Data for your plays can be found in the profile stats tab.</small>
</div>



<article class="media content-section">
    <div class="media-body">
        <h3>Completed Scorecards</h3>
<table>
    <thead>
        <tr>
            <th>{% trans 'Faction' %}</th>
            <th style="text-align: center;">Points</th>
            <th style="text-align: center;">Turns</th>

            <th>{% trans 'Player' %}</th>

        </tr>
    </thead>
    <tbody class="effort-rows">


        {% include 'the_warroom/partials/scorecard_list_partial.html' %}

</tbody>
</table>
</div>
</article>
{% else %}
    You have not recorded any scorecards
{% endif %}







{% endblock content %}


{% block scripts %}
<script>

    // Check if the element with the ID 'scorecardChart' exists
    const factionChartsElement = document.getElementById('scorecardChart');
    if (factionChartsElement) { 
        
    // Get the game ID dynamically from the template
    const recorderSlug = "{{ user.profile.slug }}";  // Replace with actual game ID (from Django template)

    // Define the endpoint to fetch data from
    const endpoint = `/api/scorecard/player/${recorderSlug}/?recorder=True`;

    // Fetch the data from the API
    fetch(endpoint)
        .then(response => response.json())  // Parse the JSON response
        .then(data => {

            // Check if the response contains the "No scorecards found" message
            if (data.message && data.message === "No scorecards found.") {
                const factionChartsElement = document.getElementById('scorecardContainer');
                if (factionChartsElement) {
                    factionChartsElement.remove();  // This will remove the entire element
                }
                return;  // Exit the function if no scorecards are found
            }

            // Data processing
            const labels = [];  // Turn numbers (x-axis)
            const datasets = [];  // One dataset per faction

            // Extract all turn numbers from the data
            const turnNumbers = [];
            for (const faction in data) {
                data[faction].averages.forEach(turnData => {
                    if (!turnNumbers.includes(turnData.turn_number)) {
                        turnNumbers.push(turnData.turn_number);  // Collect unique turn numbers
                    }
                });
            }

            // Sort turn numbers in ascending order
            turnNumbers.sort((a, b) => a - b);
            labels.push(...turnNumbers.map(turn => `Turn ${turn}`));  // Prepare x-axis labels

            // Iterate over the factions to create datasets for each
            for (const faction in data) {
                const factionData = data[faction];
                let color = factionData.color ? factionData.color : getRandomColor();  // Faction color or random color

                // Map the average game points for each turn in the current faction
                const gamePoints = turnNumbers.map(turn => {
                    const turnData = factionData.averages.find(t => t.turn_number === turn);
                    return turnData ? turnData.average_game_points : null;  // Default to null if no data for this turn
                });

                // Create the dataset for this faction
                datasets.push({
                    label: `${factionData.faction} (${factionData.count})`,  // Name of the faction
                    data: gamePoints,  // y-axis data (average game points)
                    fill: false,  // Don't fill the area under the line
                    borderColor: color,
                    tension: 0.1 // Line smoothing
                });
            }

            // Create the chart using Chart.js
            const ctx = document.getElementById('scorecardChart').getContext('2d');
            const scorecardChart = new Chart(ctx, {
                type: 'line',  // Line chart type
                data: {
                    labels: labels,  // x-axis labels (turn numbers)
                    datasets: datasets  // One dataset per faction
                },
                options: {
                    responsive: false,
                    {% comment %} maintainAspectRatio: false, {% endcomment %}
                    scales: {
                        x: {
                            title: {
                                display: false,
                                text: 'Turn Number'
                            }
                        },
                        y: {
                            title: {
                                display: false,
                                text: 'Average Game Points'
                            },
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5,  // Set the y-axis step size to 5 points per block
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',  // Move the legend below the chart
                            align: 'center',  // Align the legend items to the center (optional)
                        },
                        tooltip: {
                            enabled: true,  // This enables tooltips by default
                            mode: 'nearest',  // This controls how tooltips are triggered ('nearest' is common for line charts)
                            intersect: false,  // Makes the tooltip show when you hover near the line, not necessarily over the data point
                            callbacks: {
                                label: function(tooltipItem) {
                                        // Access the dataset label from the datasetIndex
                                        var datasetLabel = tooltipItem.chart.data.datasets[tooltipItem.datasetIndex].label;

                                        // Return the legend label and the value (e.g., 'Faction: 45')
                                        return datasetLabel + ': ' + tooltipItem.raw;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',  // This can also be 'nearest' or 'point' depending on your use case
                        intersect: false  // Tooltip will show when hovering near the data point, not just on it
                    } 
                }
            });
        })
        .catch(error => {
            console.error("Error fetching the data:", error);
        });

    // Function to generate random colors for each faction's line
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
}
// Get the collapse element and button
const collapseElement = document.getElementById('collapseRegister');
const collapseToggleButton = document.getElementById('collapseToggleButton');

// Add event listeners to the collapse element
collapseElement.addEventListener('show.bs.collapse', function () {
    // Change button text to "Hide" when collapse is shown
    collapseToggleButton.innerHTML = 'Hide';
});

collapseElement.addEventListener('hide.bs.collapse', function () {
    // Change button text to "View" when collapse is hidden
    collapseToggleButton.innerHTML = 'View';
});
</script>
{% endblock scripts %}